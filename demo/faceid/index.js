/*
  Human
  homepage: <https://github.com/vladmandic/human>
  author: <https://github.com/vladmandic>'
*/

import*as B from"../../dist/human.esm.js";var l,R="human",g="person",p=(...t)=>console.log("indexdb",...t);async function v(){return l?!0:new Promise(t=>{let a=indexedDB.open(R,1);a.onerror=s=>p("error:",s),a.onupgradeneeded=s=>{p("create:",s.target),l=s.target.result,l.createObjectStore(g,{keyPath:"id",autoIncrement:!0})},a.onsuccess=s=>{l=s.target.result,p("open:",l),t(!0)}})}async function x(){let t=[];return l||await v(),new Promise(a=>{let s=l.transaction([g],"readwrite").objectStore(g).openCursor(null,"next");s.onerror=i=>p("load error:",i),s.onsuccess=i=>{i.target.result?(t.push(i.target.result.value),i.target.result.continue()):a(t)}})}async function y(){return l||await v(),new Promise(t=>{let a=l.transaction([g],"readwrite").objectStore(g).count();a.onerror=s=>p("count error:",s),a.onsuccess=()=>t(a.result)})}async function C(t){l||await v();let a={name:t.name,descriptor:t.descriptor,image:t.image};l.transaction([g],"readwrite").objectStore(g).put(a),p("save:",a)}async function D(t){l||await v(),l.transaction([g],"readwrite").objectStore(g).delete(t.id),p("delete:",t)}var b={modelBasePath:"../../models",filter:{equalization:!0},face:{enabled:!0,detector:{rotation:!0,return:!0,cropFactor:1.6,mask:!1},description:{enabled:!0},iris:{enabled:!0},emotion:{enabled:!1},antispoof:{enabled:!0},liveness:{enabled:!0}},body:{enabled:!1},hand:{enabled:!1},object:{enabled:!1},gesture:{enabled:!0}},E={order:2,multiplier:25,min:.2,max:.8},c={minConfidence:.6,minSize:224,maxTime:1e4,blinkMin:10,blinkMax:800,threshold:.5,mask:b.face.detector.mask,rotation:b.face.detector.rotation,cropFactor:b.face.detector.cropFactor,...E},o={faceCount:!1,faceConfidence:!1,facingCenter:!1,lookingCenter:!1,blinkDetected:!1,faceSize:!1,antispoofCheck:!1,livenessCheck:!1,elapsedMs:0},I=()=>o.faceCount&&o.faceSize&&o.blinkDetected&&o.facingCenter&&o.lookingCenter&&o.faceConfidence&&o.antispoofCheck&&o.livenessCheck,r={face:null,record:null},u={start:0,end:0,time:0},n=new B.Human(b);n.env.perfadd=!1;n.draw.options.font='small-caps 18px "Lato"';n.draw.options.lineHeight=20;var e={video:document.getElementById("video"),canvas:document.getElementById("canvas"),log:document.getElementById("log"),fps:document.getElementById("fps"),match:document.getElementById("match"),name:document.getElementById("name"),save:document.getElementById("save"),delete:document.getElementById("delete"),retry:document.getElementById("retry"),source:document.getElementById("source"),ok:document.getElementById("ok")},w={detect:0,draw:0},h={detect:0,draw:0},S=0,f=(...t)=>{e.log.innerText+=t.join(" ")+`
`,console.log(...t)},k=t=>e.fps.innerText=t;async function H(){k("starting webcam...");let t={audio:!1,video:{facingMode:"user",resizeMode:"none",width:{ideal:document.body.clientWidth}}},a=await navigator.mediaDevices.getUserMedia(t),s=new Promise(i=>{e.video.onloadeddata=()=>i(!0)});e.video.srcObject=a,e.video.play(),await s,e.canvas.width=e.video.videoWidth,e.canvas.height=e.video.videoHeight,n.env.initial&&f("video:",e.video.videoWidth,e.video.videoHeight,"|",a.getVideoTracks()[0].label),e.canvas.onclick=()=>{e.video.paused?e.video.play():e.video.pause()}}async function T(){var t;if(!e.video.paused){(t=r.face)!=null&&t.tensor&&n.tf.dispose(r.face.tensor),await n.detect(e.video);let a=n.now();h.detect=1e3/(a-w.detect),w.detect=a,requestAnimationFrame(T)}}async function L(){let t=n.next(n.result);n.draw.canvas(e.video,e.canvas),await n.draw.all(e.canvas,t);let a=n.now();if(h.draw=1e3/(a-w.draw),w.draw=a,k(`fps: ${h.detect.toFixed(1).padStart(5," ")} detect | ${h.draw.toFixed(1).padStart(5," ")} draw`),o.faceCount=n.result.face.length===1,o.faceCount){let i=Object.values(n.result.gesture).map(m=>m.gesture);(i.includes("blink left eye")||i.includes("blink right eye"))&&(u.start=n.now()),u.start>0&&!i.includes("blink left eye")&&!i.includes("blink right eye")&&(u.end=n.now()),o.blinkDetected=o.blinkDetected||Math.abs(u.end-u.start)>c.blinkMin&&Math.abs(u.end-u.start)<c.blinkMax,o.blinkDetected&&u.time===0&&(u.time=Math.trunc(u.end-u.start)),o.facingCenter=i.includes("facing center"),o.lookingCenter=i.includes("looking center"),o.faceConfidence=(n.result.face[0].boxScore||0)>c.minConfidence&&(n.result.face[0].faceScore||0)>c.minConfidence,o.antispoofCheck=(n.result.face[0].real||0)>c.minConfidence,o.livenessCheck=(n.result.face[0].live||0)>c.minConfidence,o.faceSize=n.result.face[0].box[2]>=c.minSize&&n.result.face[0].box[3]>=c.minSize}let s=32;for(let[i,m]of Object.entries(o)){let d=document.getElementById(`ok-${i}`);d||(d=document.createElement("div"),d.innerText=i,d.className="ok",d.style.top=`${s}px`,e.ok.appendChild(d)),typeof m=="boolean"?d.style.backgroundColor=m?"lightgreen":"lightcoral":d.innerText=`${i}:${m}`,s+=28}return I()||o.elapsedMs>c.maxTime?(e.video.pause(),n.result.face[0]):(o.elapsedMs=Math.trunc(n.now()-S),new Promise(i=>{setTimeout(async()=>{await L(),i(n.result.face[0])},30)}))}async function z(){var t,a,s,i;if(e.name.value.length>0){let m=(t=e.canvas.getContext("2d"))==null?void 0:t.getImageData(0,0,e.canvas.width,e.canvas.height),d={id:0,name:e.name.value,descriptor:(a=r.face)==null?void 0:a.embedding,image:m};await C(d),f("saved face record:",d.name,"descriptor length:",(i=(s=r.face)==null?void 0:s.embedding)==null?void 0:i.length),f("known face records:",await y())}else f("invalid name")}async function P(){r.record&&r.record.id>0&&await D(r.record)}async function j(){var i,m;if((i=e.canvas.getContext("2d"))==null||i.clearRect(0,0,c.minSize,c.minSize),!r.face||!r.face.tensor||!r.face.embedding)return!1;if(console.log("face record:",r.face),n.tf.browser.toPixels(r.face.tensor,e.canvas),await y()===0)return f("face database is empty"),document.body.style.background="black",e.delete.style.display="none",!1;let t=await x(),a=t.map(d=>d.descriptor).filter(d=>d.length>0),s=n.match(r.face.embedding,a,E);return r.record=t[s.index]||null,r.record&&(f(`best match: ${r.record.name} | id: ${r.record.id} | similarity: ${Math.round(1e3*s.similarity)/10}%`),e.name.value=r.record.name,e.source.style.display="",(m=e.source.getContext("2d"))==null||m.putImageData(r.record.image,0,0)),document.body.style.background=s.similarity>c.threshold?"darkgreen":"maroon",s.similarity>c.threshold}async function M(){var t,a;return o.faceCount=!1,o.faceConfidence=!1,o.facingCenter=!1,o.blinkDetected=!1,o.faceSize=!1,o.antispoofCheck=!1,o.livenessCheck=!1,o.elapsedMs=0,e.match.style.display="none",e.retry.style.display="none",e.source.style.display="none",document.body.style.background="black",await H(),await T(),S=n.now(),r.face=await L(),e.canvas.width=((t=r.face.tensor)==null?void 0:t.shape[1])||c.minSize,e.canvas.height=((a=r.face.tensor)==null?void 0:a.shape[0])||c.minSize,e.source.width=e.canvas.width,e.source.height=e.canvas.height,e.canvas.style.width="",e.match.style.display="flex",e.save.style.display="flex",e.delete.style.display="flex",e.retry.style.display="block",I()?j():(f("did not find valid face"),!1)}async function q(){var t,a;f("human version:",n.version,"| tfjs version:",n.tf.version["tfjs-core"]),f("face embedding model:",b.face.description.enabled?"faceres":"",(t=b.face.mobilefacenet)!=null&&t.enabled?"mobilefacenet":"",(a=b.face.insightface)!=null&&a.enabled?"insightface":""),f("options:",JSON.stringify(c).replace(/{|}|"|\[|\]/g,"").replace(/,/g," ")),k("loading..."),f("known face records:",await y()),await H(),await n.load(),k("initializing..."),e.retry.addEventListener("click",M),e.save.addEventListener("click",z),e.delete.addEventListener("click",P),await n.warmup(),await M()}window.onload=q;
//# sourceMappingURL=index.js.map
